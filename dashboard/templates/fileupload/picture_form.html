{% extends 'base.html' %}

{% block sidebar %}
    {% include 'projadmin/sidebar.html' %}
{% endblock %}

{% block main %}
    <div class="main_content">
	<div class="dash_block">
	    
	    <div class="left">
		Image Type: </br>
		<select>
		    <option value="ami" selected>AMI</option>
		    <option value="qcow">QCOW2</option>
		</select>
		</br></br>
		
		<div class="qcow2" style="display:none" id="image_form">
		    <form enctype="multipart/form-data" method="post" action="/upload/new/" id="form1" style="width:250px">
			Title:<br/>
			<input type="text" name="title" id="title"/><br/><br/><br/>
			<p>Image:</p>
			<input type="file" name="image" id="image"/><br/><br/>
			<input type="button" onClick="uploadFile2()" value="Upload"><br/>
		    </form>
		</div>
		
		<div class="ami" id="image_form">
		    <form enctype="multipart/form-data" method="post" action="/upload/new/" id="form1" style="width:250px;">
			{% csrf_token %}
			{% for field in form.visible_fields %}
			    {{ field.label_tag }}<br/>
			    {{ field.errors }}
			    {{ field }}<br/><br/><br/>
			{% endfor %}
			<input type="button" value="Upload" onclick="uploadFile()"/>
		    </form>
		    <br/>
		</div>
	    
	    </div>
	    <div class="rigth">
		<h3>Description<h3>
		<p>From here you can upload an image. </p>
		<div class="progress"></div>
		<div class="speed"></div>
		<div class="success"></div>
		<div class="avg"></div>
		<div class="eta"></div>
	    </div>
	    
	    <div class="clear">&nbsp</div>
	</div>
    </div>
{% endblock %}
{% block footer_js %}
<script>
	
	    $("select").change(function(){
		if ($("select option:selected").attr("value") == "ami"){
		    $("div.qcow2").hide();
		    $("div.ami").show();
		}
		else{
		    $("div.qcow2").show();
		    $("div.ami").hide();
		}
	    });
	
	
	function uploadFile() {
        $("div.success").html("Loading...");
        var xhr = new XMLHttpRequest();
        var fd = new FormData();
        fd.append("name", document.getElementById('id_title').value);
        kernel = document.getElementById('id_kernel').files[0];
        initrd = document.getElementById('id_initrd').files[0]
    	fd.append("kernel", kernel);
    	fd.append("initrd", initrd);
        fd.append("rootfs", document.getElementById('id_rootfs').files[0]);
        xhr.upload.addEventListener("progress", progress, false);
        xhr.addEventListener("load", success, false);
        xhr.open("POST", "../js/", true);
        xhr.send(fd);
      }

      function uploadFile2() {
        $("div.success").html("Loading...");
        var xhr = new XMLHttpRequest();
        var fd = new FormData();
        fd.append("name", document.getElementById('title').value);
        fd.append("rootfs", document.getElementById('image').files[0]);
        xhr.upload.addEventListener("progress", progress, false);
        xhr.addEventListener("load", success, false);
        xhr.open("POST", "../js/", true);
        xhr.send(fd);
      }
      
      function success() {
        $("div.progress").html("");
        $("div.success").html("Loaded!");
        window.location = "../../images"
      }

      prev_time = (new Date()).getTime();
      prev_size = 0;
      
      speeds = [];

      function progress(evt) {
        full_size = evt.total;
        $("div.progress").html("Loaded: " + evt.loaded + '/' + evt.total + "<br/>" + "Percent: " + ((evt.loaded/evt.total)*100).toFixed(2) + "%");
        current_time = (new Date()).getTime();
        time_deltha = current_time - prev_time;
        size_deltha = evt.loaded - prev_size;
        speed = size_deltha/time_deltha;
        prev_time = current_time;
        prev_size = evt.loaded;
        $("div.speed").html("Speed: " + speed.toFixed(2));
        speeds.push(speed)
      
        avg = 0;
        for (i = 0; i < speeds.length; i++){
          avg += speeds[i];
        }
        
        avg /= speeds.length;
        
        $("div.avg").html("Average Speed: " + avg.toFixed(2));
        $("div.eta").html("ETA: " + Math.round(((evt.total - prev_size)/avg)/1000) + "s"
        );

      }

</script>
{% endblock %}
